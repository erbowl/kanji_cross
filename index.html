<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>漢字クロスゲーム</title>
    <!-- <script src="html2canvas.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.js"></script>    
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta1/html2canvas.min.js"></script> -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
    <style>
      table {
        margin-bottom: 20px;
        background-color: #fff;
      }
      td {
        border: 1px solid #627295;
        height: 40px;
        width: 40px;
        font-size: 20px;
        vertical-align: middle;
        text-align: center;
        font-family: “游明朝”, YuMincho, “ヒラギノ明朝 ProN W3”,
          “Hiragino Mincho ProN”, “ＭＳ Ｐ明朝”, “ＭＳ 明朝”, serif;
        transform: rotate(0.03deg);
        -webkit-transform: rotate(0.03deg);
        border-radius: 3%;
        box-sizing: border-box;
        font-weight: bold;
      }
      td.select_ok {
        background-color: rgba(233, 255, 136, 0.3);
      }
      td.used {
        background-color: rgba(172, 172, 172, 0.3);
      }
      .btn-square {
        display: inline-block;
        padding: 0.5em 1em;
        text-decoration: none;
        background: #668ad8; /*ボタン色*/
        color: #fff;
        border-bottom: solid 4px #627295;
        border-radius: 3px;
      }
      .btn-square:active {
        /*ボタンを押したとき*/
        -webkit-transform: translateY(4px);
        transform: translateY(4px); /*下に動く*/
        border-bottom: none; /*線を消す*/
      }
      .selected {
        border: 2px solid red;
      }
      .unable {
        background-color: darkgrey;
      }
      h1 {
        color: #364e96; /*文字色*/
        padding: 0.5em 0; /*上下の余白*/
        border-top: solid 3px #364e96; /*上線*/
        border-bottom: solid 3px #364e96; /*下線*/
      }
      .box6 {
          padding: 0.5em 1em;
          margin: 2em 0;
          background: #f0f7ff;
          border: dashed 2px #5b8bd0;/*点線*/
      }
      .box6 p {
          margin: 0; 
          padding: 0;
      }
      .box8 {
          padding: 0.5em 1em;
          margin: 2em 0;
          color: #232323;
          background: #fff8e8;
          border-left: solid 10px #ffc06e;
      }
      .box8 p {
          margin: 0; 
          padding: 0;
      }
    </style>
  </head>
  <body>
    <h1>漢字クロスゲーム</h1>
    <h2>サイズ</h2>
    <a href="/?size=3">小</a>
    <a href="/?size=6">中</a>
    <a href="/?size=9">大</a>
    <a href="/?size=12">特大</a>
    <a href="/?size=24">超特大</a>
    <h2>ルール</h2>

    <h3>自分の手番でやること</h3>
    <div class="box6">
        <ol>
            <li>
              選択された欄の上下左右で熟語を構成する漢字を回答(初手は自由な漢字を選択)
            </li>
            <li>[次の回答者が回答するべき欄]を選択</li>
          </ol>
    </div>
    
    <h3>勝利条件</h3>
    <div class="box8">
        <ul>
            <li>相手が回答が存在しない欄を選択してくること</li>
            <li>回答が存在するが、相手が答えられない空欄を選択すること</li>
          </ul>
    </div>
   
    <table id="table"></table>
    <a  href="javascript:void(0);"id="input_done" class="btn-square" tabindex="1002" >入力完了</a>
    <a  href="javascript:void(0);"id="compute_button" class="btn-square" tabindex="1003">コンピューターに入力させる</a>
    <a  href="javascript:void(0);"id="compute_select" style="display:none" class="btn-square" tabindex="1004"
      >コンピューターに選択させる</a
    >
    <a id="save" class="btn-square" tabindex="1006"
      >画像を保存</a
    >
    <script>      
      var data_1_2;
      var data_2_1;
      var exist;
      var used = {};
      imageUpdate();
      $.getJSON("json/1_2.json", function(data) {
        data_1_2 = data;
      });
      $.getJSON("json/2_1.json", function(data) {
        data_2_1 = data;
      });
      $.getJSON("json/exist.json", function(data) {
        exist = data;
      });
      var m = 3;
      if (getParam("size")) {
        m = parseInt(getParam("size"));
      }

      const n = m * 2 + 1;
      for (let index = 0; index < n; index++) {
        $tr = $("table").append("<tr></tr>");
        for (let jndex = 0; jndex < n; jndex++) {
          $tr.append('<td id="' + index + "_" + jndex + '" ></td>');
        }
      }

      var input_time = true;
      var now = "#" + m + "_" + m;
      $(now)
        .addClass("selected")
        .attr("contentEditable", "true")
        .attr("tabindex", 1)
        .focus();

      $("#compute_button").on("click", function() {
        change(compute(now));
      });

      $("#compute_select").on("click", function() {
        compute_select();
      });

      $("#input_done").on("click", function() {
        change($(now).text());
      });

      function getParam(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return "";
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      function now_split(str) {
        return str
          .replace("#", "")
          .split("_")
          .map(function(v) {
            return parseInt(v);
          });
      }

      function change(value) {
        if (input_time) {
          var h = now_split(now)[0];
          var w = now_split(now)[1];
          // computer側が答えがないときだけnullが来る
          if(value === null){
            alert('該当する漢字がありません');
            return;
          }
          if (value.length != 1 || !/[\u3400-\u9FFF]/.test(value)) {
            alert("漢字1文字を入力すること");
            return;
          }
          $(now).text(value);
          // 可能か判定
          var ok = true;
          $.each([-1, 1], function(index, v1) {
            $.each([-1, 1], function(index2, v2) {
              var tmp_h, tmp_w;
              if (v2 == -1) {
                tmp_h = h + v1;
                tmp_w = w;
              } else {
                tmp_h = h;
                tmp_w = w + v1;
              }
              if (!(tmp_h < 0 || tmp_h >= n || tmp_w < 0 || tmp_w >= n)) {
                if ($("#" + tmp_h + "_" + tmp_w).text()) {
                  var front;
                  var back;
                  if (v1 == -1) {
                    front = $("#" + tmp_h + "_" + tmp_w).text();
                    back = $(now).text();
                  } else {
                    back = $("#" + tmp_h + "_" + tmp_w).text();
                    front = $(now).text();
                  }
                  if (!exist[front + back] || used[$(now).text()]) {
                    console.log([front, back]);
                    ok = false;
                  }
                }
              }
            });
          });

          if (ok) {
            used[$(now).text()] = true;
            $(now).addClass("used");
          } else {
            alert("存在しません/だめです");
            $(now).text("");
            $(now).focus();
            return ;
          }

          // 次は選択中
          $("td").attr("contentEditable", "false").removeAttr("tabindex");

          // 選択できるものを
          $("td.used").each(function(inin,element){
            var id = $(element).attr("id");
            var h = now_split(id)[0];
            var w = now_split(id)[1];
            $.each([-1, 1], function(index, v1) {
              $.each([-1, 1], function(index2, v2) {
                var tmp_h, tmp_w;
                if (v2 == -1) {
                  tmp_h = h + v1;
                  tmp_w = w;
                } else {
                  tmp_h = h;
                  tmp_w = w + v1;
                }
                if (!(tmp_h < 0 || tmp_h >= n || tmp_w < 0 || tmp_w >= n)) {
                  if ( !$("#" + tmp_h + "_" + tmp_w).hasClass("used") ) {
                    $("#" + tmp_h + "_" + tmp_w).addClass("select_ok");
                  }
                }
              });
            });
          })
          $("td.select_ok:not(.used)").attr("tabindex",1);

          $("#input_done").text("選択完了");
          
          input_time = !input_time;
          $("#compute_button").hide();
          $("#compute_select").show();

          // 画像化用
          imageUpdate();
        } else {
          $("#input_done").text("入力完了");

          $("td").removeAttr("tabindex");
          $(now)
            .attr("contentEditable", "true")
            .attr("tabindex", 1)
            .focus();
          console.log(now);
          input_time = !input_time;
          $("#compute_button").show();
          $("#compute_select").hide();
        }
      }

      $("td").on("click focus", function() {
        if (input_time) {
          return 0;
        }
        select(this);
      });

      function imageUpdate(){
        // 画像化用
        scrollPos = $(window).scrollTop();
        console.log(scrollPos);
        html2canvas(document.getElementById('table'), {
            onrendered: function(canvas) {
              console.log(scrollPos);
              window.scrollTo(0,scrollPos);

              $downloadLink = $('#save');
              $downloadLink.attr("href",canvas.toDataURL('image/png'));
              $downloadLink.attr("download","kanji_cross.png");
            },
            scale:2
        });
      }

      function select(target) {
        if( $(target).hasClass("used") ){
          return;
        }
        if( !$(target).hasClass("select_ok") ){
          return;
        }
        $("td").removeClass("selected");
        $(target).addClass("selected");
        now = "#" + $(target).attr("id");
      }

      function compute(now) {
        var h = now_split(now)[0];
        var w = now_split(now)[1];
        var tmp_h, tmp_w;
        var is_front = true;
        var target;
        [-1, 1].forEach(e1 => {
          [false, true].forEach(e2 => {
            tmp_h = h;
            tmp_w = w;
            if (e2) {
              tmp_h += e1;
            } else {
              tmp_w += e1;
            }
            if (0 <= tmp_h && tmp_h < n && 0 <= tmp_w && tmp_w < n) {
              if ($("#" + tmp_h + "_" + tmp_w).text()) {
                is_front = e1 == -1;
                target = $("#" + tmp_h + "_" + tmp_w).text();
              }
            }
          });
        });

        if (!target) {
          var keys = Object.keys(data_1_2);
          var key = keys[(keys.length * Math.random()) << 0];
          // console.log(array[Math.floor(Math.random() * array.length)]);
          // $(now).text(key);

          // change(key);
          return key;
        }

        var list;
        if (is_front) {
          list = data_1_2[target];
        } else {
          list = data_2_1[target];
        }
        var exist_kanji = false;

        var result_kanji = [];
        if (!list) {
          // alert("存在しません");
          return null;
        }
        if (list.length == 0) {
          return null;
        }
        list.forEach(koho => {
          var ok = true;
          ok = !used[koho];
          [-1, 1].forEach(e1 => {
            [false, true].some(e2 => {
              if (!ok) {
                return true;
              }
              tmp_h = h;
              tmp_w = w;
              if (e2) {
                tmp_h += e1;
              } else {
                tmp_w += e1;
              }
              if (0 <= tmp_h && tmp_h < n && 0 <= tmp_w && tmp_w < n) {
                if ($("#" + tmp_h + "_" + tmp_w).text()) {
                  // front
                  var front;
                  var back;
                  if (e1 == -1) {
                    front = $("#" + tmp_h + "_" + tmp_w).text();
                    back = koho;
                  } else {
                    back = $("#" + tmp_h + "_" + tmp_w).text();
                    front = koho;
                  }
                  if (!exist[front + back]) {
                    // console.log([front, back]);
                    ok = false;
                    return true;
                  }
                }
              }
            });
          });
          if (ok) {
            result_kanji.push(koho);
          }
        });
        if (result_kanji.length > 0) {
          var ans =
            result_kanji[Math.floor(Math.random() * result_kanji.length)];
          return ans;
        } else {
          // alert('答えは存在しません');
          return null;
        }
      }

      function compute_select() {
        var choice = {};

        $("td.used").each(function(index, element) {
          var h = now_split($(element).attr("id"))[0];
          var w = now_split($(element).attr("id"))[1];
          var tmp_h, tmp_w;
          console.log([h, w]);
          [-1, 1].forEach(e1 => {
            [false, true].forEach(e2 => {
              tmp_h = h;
              tmp_w = w;

              if (e2) {
                tmp_h += e1;
              } else {
                tmp_w += e1;
              }

              // console.log(choice);
              // console.log([tmp_h,tmp_w]);

              if (
                0 <= tmp_h &&
                tmp_h < n &&
                0 <= tmp_w &&
                tmp_w < n &&
                $("#" + tmp_h + "_" + tmp_w).text() == ""
              ) {
                var res = compute("#" + tmp_h + "_" + tmp_w);
                if (res && !used[res]) {
                  choice["#" + tmp_h + "_" + tmp_w] = true;
                }
              }
            });
          });
        });

        var keys = Object.keys(choice);
        var key = keys[(keys.length * Math.random()) << 0];
        // からやけど周りにあるやつ__
        console.log(key);
        if (!!key) {
          select(key);
          change();
        } else {
          alert("詰みです");
        }

        // compute
      }
    </script>
  </body>
</html>
